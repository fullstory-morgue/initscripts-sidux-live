#!/bin/bash
# Basic system configuration and hardware setup
# (C) Klaus Knopper <knopper@knopper.net> 2004
# (C) 2003-2006 Joerg Schirottke <master@kanotix.com>
# (C) 2005-2006 Stefan Lippers-Hollmann <s.l-h@gmx.de>

PATH="/bin:/sbin:/usr/bin:/usr/sbin"
export PATH

umask 022

# override tool behaviour through distro-defaults
FLL_DISTRO_MODE="installed"
FLL_IMAGE_DIR="SIDUX"
FLL_DISTRO_NAME="sidux"
FLL_LIVE_USER="sidux"
FLL_PERSISTENT_HOME="sidux.img"
FLL_WALLPAPER="/usr/share/wallpapers/sidux.jpg"

X_CONF="/etc/X11/xorg.conf"

[ -r /etc/default/distro ] && . /etc/default/distro

[ -z "$FLL_MOUNTPOINT" ] && FLL_MOUNTPOINT="/$FLL_IMAGE_DIR"

[ ! "$FLL_DISTRO_MODE" = "live" ] && exit 0

case "$1" in
	start)
		;;
	stop)
		;;
	restart|force-reload)
		;;
esac

# Ignore these signals: INT, TERM, SEGV
trap "" 2 3 11

# ANSI COLORS
CRE="
[K"
NORMAL="[0;39m"
# RED: Failure or error message

# GREEN: Success message
GREEN="[1;32m"
# YELLOW: Descriptions
YELLOW="[1;33m"
# BLUE: System messages
BLUE="[1;34m"
# MAGENTA: Found devices or drivers
MAGENTA="[1;35m"
# CYAN: Questions
CYAN="[1;36m"
# BOLD WHITE: Hint
WHITE="[1;37m"

# get rid of these as soon as possible
SPLASHY_PROGRESS_PIPE="/etc/sysconfig/progress"
HWSETUP_MAIN="/etc/sysconfig/knoppix"
#I18N#HWSETUP_I18N="/etc/sysconfig/i18n"
#I18N#HWSETUP_KEYBOARD="/etc/sysconfig/keyboard"
HWSETUP_MOUSE="/etc/sysconfig/mouse"
HWSETUP_SERVICES="/etc/sysconfig/services"
HWSETUP_DESKTOP="/etc/sysconfig/desktop"

### Utility Function(s)

# Simple shell grep
stringinfile()
{
	case "$(cat $2)" in
		*$1*)
			return 0
			;;
	esac

	return 1
}

# same for strings
stringinstring()
{
	case "$2" in 
		*$1*)
			return 0
			;;
	esac

	return 1
}

# Reread boot command line; echo last parameter's argument or return false.
getbootparam()
{
	stringinstring " $1=" "$CMDLINE" || return 1
	result="${CMDLINE##*$1=}"
	result="${result%%[ 	]*}"
	echo "$result"
	return 0
}

# Check boot commandline for specified option
checkbootparam()
{
	stringinstring " $1" "$CMDLINE"
	return "$?"
}

### EOF utility functions

# We need /proc here, so mount it in case we skipped the bootfloppy
[ -f /proc/version ] || mount -t proc proc /proc 2>/dev/null

# Kernel 2.6
[ -d /sys/devices ] || mount -t sysfs sysfs /sys 2>/dev/null

# Read in boot parameters
# This should work, but doesn't with Kernel 2.4.19-rc1
# CMDLINE="$(</proc/cmdline)" This should work, but doesn't with Kernel 2.4.19-rc1
# This works.
[ -z "$CMDLINE" ] && CMDLINE=" $(cat /proc/cmdline)"

# Check if we are in interactive startup mode
INTERACTIVE=""
stringinstring "BOOT_IMAGE=expert" "$CMDLINE" && INTERACTIVE="yes"

# Check if we want the config floppy
MYCONF=""
case "$CMDLINE" in
	*\ myconf*|*\ floppyconf*|*\ custom*|*\ config*)
		MYCONF="yes"
		;;
esac

if [ -n "$MYCONF" ]; then
	# Check for given config directory
	MYCONFDIR="$(getbootparam 'myconfig')"
	[ -n "$MYCONFDIR" ] || MYCONFDIR="$(getbootparam 'myconf')"
	[ -n "$MYCONFDIR" ] || MYCONFDIR="$(getbootparam 'floppyconfig')"
	[ -n "$MYCONFDIR" ] || MYCONFDIR="$(getbootparam 'floppyconf')"
	[ -n "$MYCONFDIR" ] || MYCONFDIR="$(getbootparam 'custom')"
	[ -n "$MYCONFDIR" ] || MYCONFDIR="$(getbootparam 'config')"
fi

#I18N#### localization
#I18N## Allow language specification via commandline. The default language
#I18N## will be overridden via "lang=de" boot commandline
#I18N#LANGUAGE="$(getbootparam lang 2>/dev/null)"
#I18N#[ -n "$LANGUAGE" ] || LANGUAGE="de"
#I18N#
#I18N## Set default console font (needed for first console + kernel 2.6)
#I18N#CONSOLEFONT="lat0-sun16"
#I18N#
#I18N## The default language/keyboard to use. This CANNOT be autoprobed.
#I18N## Most of these variables will be used to generate the KDE defaults
#I18N## and will be inserted into /etc/sysconfig/* below.
#I18N#case "$LANGUAGE" in
#I18N#	de-legacy)
#I18N#		# German version
#I18N#		COUNTRY="de"
#I18N#		LANG="de_DE@euro"
#I18N#		KEYTABLE="de-latin1-nodeadkeys"
#I18N#		XKEYBOARD="de"
#I18N#		KDEKEYBOARD="de"
#I18N#		CHARSET="iso8859-15"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,fr"
#I18N#		TZ="Europe/Berlin"
#I18N#		;;
#I18N#	de-utf8|de)
#I18N#		# German version UTF-8
#I18N#		LANGUAGE="de_DE:de"
#I18N#		COUNTRY="de_DE"
#I18N#		LANG="de_DE.UTF-8"
#I18N#		KEYTABLE="de-latin1-nodeadkeys"
#I18N#		XKEYBOARD="de"
#I18N#		KDEKEYBOARD="de"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,fr"
#I18N#		TZ="Europe/Berlin"
#I18N#		;;
#I18N#	au-legacy)
#I18N#		# Australian version
#I18N#		LANGUAGE="en"
#I18N#		COUNTRY="au"
#I18N#		LANG="en_AU"
#I18N#		KEYTABLE="us"
#I18N#		XKEYBOARD="us"
#I18N#		KDEKEYBOARD="us"
#I18N#		CHARSET="iso8859-1"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,fr"
#I18N#		TZ="Australia/Sydney"
#I18N#		;;
#I18N#	au-utf8|au)
#I18N#		# Australian version
#I18N#		LANGUAGE="en_AU:en"
#I18N#		COUNTRY="au"
#I18N#		LANG="en_AU.UTF-8"
#I18N#		KEYTABLE="us"
#I18N#		XKEYBOARD="us"
#I18N#		KDEKEYBOARD="us"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,fr"
#I18N#		TZ="Australia/Sydney"
#I18N#		;;
#I18N#	be-legacy)
#I18N#		# Belgian version
#I18N#		LANGUAGE="be"
#I18N#		COUNTRY="be"
#I18N#		LANG="C"
#I18N#		KEYTABLE="be2-latin1"
#I18N#		XKEYBOARD="be"
#I18N#		KDEKEYBOARD="be"
#I18N#		CHARSET="iso8859-15"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,de,fr"
#I18N#		TZ="Europe/Brussels"
#I18N#		;;
#I18N#	be-utf8|be)
#I18N#		# Belgian version
#I18N#		LANGUAGE="be_BY:be"
#I18N#		COUNTRY="be"
#I18N#		LANG="be_BY.UTF-8"
#I18N#		KEYTABLE="be2-latin1"
#I18N#		XKEYBOARD="be"
#I18N#		KDEKEYBOARD="be"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,de,fr"
#I18N#		TZ="Europe/Brussels"
#I18N#		;;
#I18N#	bg-legacy)
#I18N#		# Bulgarian version
#I18N#		LANGUAGE="bg"
#I18N#		COUNTRY="bg"
#I18N#		LANG="bg_BG"
#I18N#		KEYTABLE="bg"
#I18N#		XKEYBOARD="bg"
#I18N#		KDEKEYBOARD="bg"
#I18N#		CHARSET="microsoft-cp1251"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,de,fr"
#I18N#		TZ="Europe/Sofia"
#I18N#		;;
#I18N#	bg-utf8|be)
#I18N#		# Bulgarian version
#I18N#		LANGUAGE="bg_BG:bg"
#I18N#		COUNTRY="bg"
#I18N#		LANG="bg_BG.UTF-8"
#I18N#		KEYTABLE="bg"
#I18N#		XKEYBOARD="bg"
#I18N#		KDEKEYBOARD="bg"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,de,fr"
#I18N#		TZ="Europe/Sofia"
#I18N#		;;
#I18N#	br-legacy)
#I18N#		# Brazilian Version
#I18N#		LANGUAGE="pt_BR"
#I18N#		COUNTRY="br"
#I18N#		LANG="pt_BR"
#I18N#		KEYTABLE="br-abnt2"
#I18N#		XKEYBOARD="abnt2"
#I18N#		KDEKEYBOARD="br"
#I18N#		CHARSET="iso8859-1"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,br"
#I18N#		TZ="America/Sao_Paulo"
#I18N#		;;
#I18N#	br-utf8|be)
#I18N#		# Brazilian Version
#I18N#		LANGUAGE="pt_BR:pt"
#I18N#		COUNTRY="br"
#I18N#		LANG="pt_BR.UTF-8"
#I18N#		KEYTABLE="br-abnt2"
#I18N#		XKEYBOARD="abnt2"
#I18N#		KDEKEYBOARD="br"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,br"
#I18N#		TZ="America/Sao_Paulo"
#I18N#		;;
#I18N#	ch-legacy)
#I18N#		# Swiss version (basically de with some modifications)
#I18N#		LANGUAGE="de"
#I18N#		COUNTRY="ch"
#I18N#		LANG="de_CH"
#I18N#		KEYTABLE="sg-latin1"
#I18N#		XKEYBOARD="de_CH"
#I18N#		KDEKEYBOARD="de_CH"
#I18N#		CHARSET="iso8859-15"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="de,us,fr"
#I18N#		TZ="Europe/Zurich"
#I18N#		;;
#I18N#	ch-utf8|ch)
#I18N#		# Swiss version (basically de with some modifications)
#I18N#		LANGUAGE="de_CH:de"
#I18N#		COUNTRY="ch"
#I18N#		LANG="de_CH.UTF-8"
#I18N#		KEYTABLE="sg-latin1"
#I18N#		XKEYBOARD="de_CH"
#I18N#		KDEKEYBOARD="de_CH"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="de,us,fr"
#I18N#		TZ="Europe/Zurich"
#I18N#		;;
#I18N#	cn-legacy)
#I18N#		# Simplified Chinese version
#I18N#		COUNTRY="cn"
#I18N#		LANG="zh_CN.GB2312"
#I18N#		KEYTABLE="us"
#I18N#		XKEYBOARD="us"
#I18N#		KDEKEYBOARD="us"
#I18N#		CHARSET="gb2312.1980-0"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,de,fr"
#I18N#		XMODIFIERS="@im=Chinput"
#I18N#		TZ="Asia/Shanghai"
#I18N#		;;
#I18N#	cn-utf8|cn)
#I18N#		# Simplified Chinese version
#I18N#		COUNTRY="zh_CN:cn"
#I18N#		LANG="zh_CN.UTF-8"
#I18N#		KEYTABLE="us"
#I18N#		XKEYBOARD="us"
#I18N#		KDEKEYBOARD="us"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,de,fr"
#I18N#		XMODIFIERS="@im=Chinput"
#I18N#		TZ="Asia/Shanghai"
#I18N#		;;
#I18N#	cs-legacy|cz-legacy)
#I18N#		# Czech version
#I18N#		LANGUAGE="cs"
#I18N#		COUNTRY="cs"
#I18N#		LANG="cs_CZ"
#I18N#		KEYTABLE="cz-lat2"
#I18N#		XKEYBOARD="cs"
#I18N#		KDEKEYBOARD="cs"
#I18N#		CHARSET="iso8859-2"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,de,fr"
#I18N#		TZ="Europe/Prague"
#I18N#		CONSOLEFONT="iso02g"
#I18N#		;;
#I18N#	cs-utf8|cz-utf8|cs|cz)
#I18N#		# Czech version
#I18N#		LANGUAGE="cs_CZ:cs"
#I18N#		COUNTRY="cs"
#I18N#		LANG="cs_CZ.UTF-8"
#I18N#		KEYTABLE="cz-lat2"
#I18N#		XKEYBOARD="cs"
#I18N#		KDEKEYBOARD="cs"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,de,fr"
#I18N#		TZ="Europe/Prague"
#I18N#		CONSOLEFONT="iso02g"
#I18N#		;;
#I18N#	dk-legacy|da-legacy)
#I18N#		# Dansk version
#I18N#		COUNTRY="dk"
#I18N#		LANG="da_DK"
#I18N#		# Workaround: "dk" broken in gettext, use da:da_DK
#I18N#		LANGUAGE="da:da_DK"
#I18N#		# Keytable "dk" is correct.
#I18N#		KEYTABLE="dk"
#I18N#		XKEYBOARD="dk"
#I18N#		KDEKEYBOARD="dk"
#I18N#		CHARSET="iso8859-15"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="dk,de,us,fr"
#I18N#		TZ="Europe/Copenhagen"
#I18N#		;;
#I18N#	dk-utf8|da-utf8|dk|da)
#I18N#		# Dansk version
#I18N#		COUNTRY="dk"
#I18N#		LANG="da_DK.UTF-8"
#I18N#		# Workaround: "dk" broken in gettext, use da:da_DK
#I18N#		LANGUAGE="da_DK:da"
#I18N#		# Keytable "dk" is correct.
#I18N#		KEYTABLE="dk"
#I18N#		XKEYBOARD="dk"
#I18N#		KDEKEYBOARD="dk"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="dk,de,us,fr"
#I18N#		TZ="Europe/Copenhagen"
#I18N#		;;
#I18N#	el-legacy)
#I18N#		# Greek version
#I18N#		LANGUAGE="el"
#I18N#		COUNTRY="gr"
#I18N#		LANG="el_GR"
#I18N#		KEYTABLE="gr"
#I18N#		XKEYBOARD="us,el"
#I18N#		KDEKEYBOARD="us"
#I18N#		CHARSET="iso8859-7"
#I18N#		CONSOLEFONT="iso07.f16"
#I18N#		IOCHARSET="8859-7"
#I18N#		IOCODEPAGE="737"
#I18N#		SYSFONTACM="iso07"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="el"
#I18N#		TZ="Europe/Athens"
#I18N#		;;
#I18N#	el-utf8|el)
#I18N#		# Greek version
#I18N#		LANGUAGE="el_GR:el"
#I18N#		COUNTRY="gr"
#I18N#		LANG="el_GR.UTF-8"
#I18N#		KEYTABLE="gr"
#I18N#		XKEYBOARD="us,el"
#I18N#		KDEKEYBOARD="us"
#I18N#		CHARSET="utf8"
#I18N#		CONSOLEFONT="iso07.f16"
#I18N#		IOCHARSET="8859-7"
#I18N#		IOCODEPAGE="737"
#I18N#		SYSFONTACM="iso07"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="el"
#I18N#		TZ="Europe/Athens"
#I18N#		;;
#I18N#	es-legacy)
#I18N#		# Spanish version
#I18N#		COUNTRY="es"
#I18N#		LANG="es_ES@euro"
#I18N#		KEYTABLE="es"
#I18N#		XKEYBOARD="es"
#I18N#		KDEKEYBOARD="es"
#I18N#		CHARSET="iso8859-15"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="de,us,fr"
#I18N#		TZ="Europe/Madrid"
#I18N#		;;
#I18N#	es-utf8|es)
#I18N#		# Spanish version
#I18N#		LANGUAGE="es_ES:es"
#I18N#		COUNTRY="es"
#I18N#		LANG="es_ES.UTF-8"
#I18N#		KEYTABLE="es"
#I18N#		XKEYBOARD="es"
#I18N#		KDEKEYBOARD="es"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="de,us,fr"
#I18N#		TZ="Europe/Madrid"
#I18N#		CONSOLEFONT="lat10-16"
#I18N#		;;
#I18N#	fi-legacy)
#I18N#		# Finnish version, though we may not have the kde-i18n files
#I18N#		COUNTRY="fi"
#I18N#		LANG="fi_FI@euro"
#I18N#		KEYTABLE="fi-latin1"
#I18N#		XKEYBOARD="fi"
#I18N#		KDEKEYBOARD="fi"
#I18N#		CHARSET="iso8859-15"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us"
#I18N#		TZ="Europe/Helsinki"
#I18N#		;;
#I18N#	fi-utf8|fi)
#I18N#		# Finnish version, though we may not have the kde-i18n files
#I18N#		LANGUAGE="fi_FI:fi"
#I18N#		COUNTRY="fi"
#I18N#		LANG="fi_FI.UTF-8"
#I18N#		KEYTABLE="fi-latin1"
#I18N#		XKEYBOARD="fi"
#I18N#		KDEKEYBOARD="fi"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us"
#I18N#		TZ="Europe/Helsinki"
#I18N#		;;
#I18N#	fr-legacy)
#I18N#		# French version
#I18N#		COUNTRY="fr"
#I18N#		LANG="fr_FR@euro"
#I18N#		KEYTABLE="fr"
#I18N#		XKEYBOARD="fr"
#I18N#		KDEKEYBOARD="fr"
#I18N#		CHARSET="iso8859-15"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="de,us"
#I18N#		TZ="Europe/Paris"
#I18N#		;;
#I18N#	fr-utf8|fr)
#I18N#		# French version
#I18N#		LANGUAGE="fr_FR"
#I18N#		COUNTRY="fr"
#I18N#		LANG="fr_FR.UTF-8"
#I18N#		KEYTABLE="fr"
#I18N#		XKEYBOARD="fr"
#I18N#		KDEKEYBOARD="fr"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="de,us"
#I18N#		TZ="Europe/Paris"
#I18N#		;;
#I18N#	ga-legacy)
#I18N#		# Irish Gaeilge version
#I18N#		COUNTRY="ie"
#I18N#		LANG="ga_IE@euro"
#I18N#		KEYTABLE="uk"
#I18N#		XKEYBOARD="uk"
#I18N#		KDEKEYBOARD="ie"
#I18N#		CHARSET="iso8859-15"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKYBOARDS="gb,us,de,es,fr,it"
#I18N#		TZ="Europe/Dublin"
#I18N#		;;
#I18N#	ga-utf8|ga)
#I18N#		# Irish Gaeilge version
#I18N#		COUNTRY="ie"
#I18N#		LANG="ga_IE@UTF-8"
#I18N#		KEYTABLE="uk"
#I18N#		XKEYBOARD="uk"
#I18N#		KDEKEYBOARD="ie"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKYBOARDS="gb,us,de,es,fr,it"
#I18N#		TZ="Europe/Dublin"
#I18N#		;;
#I18N#	he-legacy|il-legacy)
#I18N#		# Hebrew version
#I18N#		LANGUAGE="he"
#I18N#		COUNTRY="il"
#I18N#		LANG="he_IL"
#I18N#		KEYTABLE="us"
#I18N#		XKEYBOARD="us"
#I18N#		KDEKEYBOARD="il"
#I18N#		CHARSET="iso8859-8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,fr,de"
#I18N#		TZ="Asia/Jerusalem"
#I18N#		;;
#I18N#	he-utf8|il-utf8|he|il)
#I18N#		# Hebrew version
#I18N#		LANGUAGE="he_IL:he"
#I18N#		COUNTRY="il"
#I18N#		LANG="he_IL.UTF-8"
#I18N#		KEYTABLE="us"
#I18N#		XKEYBOARD="us"
#I18N#		KDEKEYBOARD="il"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,fr,de"
#I18N#		TZ="Asia/Jerusalem"
#I18N#		;;
#I18N#	ie-legacy)
#I18N#		# Irish (English) version
#I18N#		COUNTRY="ie"
#I18N#		LANG="en_IE@euro"
#I18N#		KEYTABLE="uk"
#I18N#		XKEYBOARD="uk"
#I18N#		KDEKEYBOARD="ie"
#I18N#		CHARSET="iso8859-15"
#I18N#		#Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="gb,us,de,es,fr,it"
#I18N#		TZ="Europe/Dublin"
#I18N#		;;
#I18N#	ie-utf8|ie)
#I18N#		# Irish (English) version
#I18N#		LANGUAGE="en_IE:en"
#I18N#		COUNTRY="ie"
#I18N#		LANG="en_IE.UTF-8"
#I18N#		KEYTABLE="uk"
#I18N#		XKEYBOARD="uk"
#I18N#		KDEKEYBOARD="ie"
#I18N#		CHARSET="utf8"
#I18N#		#Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="gb,us,de,es,fr,it"
#I18N#		TZ="Europe/Dublin"
#I18N#		;;
#I18N#	it-legacy)
#I18N#		# Italian version
#I18N#		COUNTRY="it"
#I18N#		LANG="it_IT@euro"
#I18N#		KEYTABLE="it"
#I18N#		XKEYBOARD="it"
#I18N#		KDEKEYBOARD="it"
#I18N#		CHARSET="iso8859-15"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="fr,us,de"
#I18N#		TZ="Europe/Rome"
#I18N#		;;
#I18N#	it-utf8|it)
#I18N#		# Italian version
#I18N#		LANGUAGE="it_IT"
#I18N#		COUNTRY="it"
#I18N#		LANG="it_IT.UTF-8"
#I18N#		KEYTABLE="it"
#I18N#		XKEYBOARD="it"
#I18N#		KDEKEYBOARD="it"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="fr,us,de"
#I18N#		TZ="Europe/Rome"
#I18N#		;;
#I18N#	ja-legacy)
#I18N#		# (limited) Japanese version
#I18N#		COUNTRY="jp"
#I18N#		LANG="ja_JP"
#I18N#		LANGUAGE="ja"
#I18N#		KEYTABLE="us"
#I18N#		XKEYBOARD="us"
#I18N#		KDEKEYBOARD="us"
#I18N#		CHARSET="iso8859-15"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="fr,us,de"
#I18N#		TZ="Asia/Tokyo"
#I18N#		;;
#I18N#	ja-utf8|ja)
#I18N#		# (limited) Japanese version
#I18N#		LANGUAGE="ja_JP:ja"
#I18N#		COUNTRY="jp"
#I18N#		LANG="ja_JP.UTF-8"
#I18N#		LANGUAGE="ja"
#I18N#		KEYTABLE="us"
#I18N#		XKEYBOARD="us"
#I18N#		KDEKEYBOARD="us"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="fr,us,de"
#I18N#		TZ="Asia/Tokyo"
#I18N#		;;
#I18N#	nl-legacy)
#I18N#		# Dutch version
#I18N#		COUNTRY="nl"
#I18N#		LANG="nl_NL@euro"
#I18N#		KEYTABLE="us"
#I18N#		XKEYBOARD="us"
#I18N#		KDEKEYBOARD="en_US"
#I18N#		CHARSET="iso8859-15"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="nl,de,fr"
#I18N#		TZ="Europe/Amsterdam"
#I18N#		;;
#I18N#	nl-utf8|nl)
#I18N#		# Dutch version
#I18N#		LANGUAGE="nl_NL:nl"
#I18N#		COUNTRY="nl"
#I18N#		LANG="nl_NL.UTF-8"
#I18N#		KEYTABLE="us"
#I18N#		XKEYBOARD="us"
#I18N#		KDEKEYBOARD="en_US"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="nl,de,fr"
#I18N#		TZ="Europe/Amsterdam"
#I18N#		;;
#I18N#	pl-legacy)
#I18N#		# Polish version
#I18N#		COUNTRY="pl"
#I18N#		LANG="pl_PL"
#I18N#		KEYTABLE="pl"
#I18N#		XKEYBOARD="pl"
#I18N#		KDEKEYBOARD="pl"
#I18N#		CHARSET="iso8859-2"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="de,us,fr"
#I18N#		TZ="Europe/Warsaw"
#I18N#		CONSOLEFONT="iso02g"
#I18N#		;;
#I18N#	pl-utf8|pl)
#I18N#		# Polish version
#I18N#		LANGUAGE="pl_PL:pl"
#I18N#		COUNTRY="pl"
#I18N#		LANG="pl_PL.UTF-8"
#I18N#		KEYTABLE="pl"
#I18N#		XKEYBOARD="pl"
#I18N#		KDEKEYBOARD="pl"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="de,us,fr"
#I18N#		TZ="Europe/Warsaw"
#I18N#		CONSOLEFONT="iso02g"
#I18N#		;;
#I18N#	pt-legacy)
#I18N#		# Portuguese version
#I18N#		COUNTRY="pt"
#I18N#		LANG="pt_PT@euro"
#I18N#		KEYTABLE="pt-latin1"
#I18N#		XKEYBOARD="pt"
#I18N#		KDEKEYBOARD="pt"
#I18N#		CHARSET="iso8859-1"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="de,us,fr"
#I18N#		TZ="Europe/Lisbon"
#I18N#		CONSOLEFONT="lat10-16"
#I18N#		;;
#I18N#	pt-utf8|pl)
#I18N#		# Portuguese version
#I18N#		LANGUAGE="pt_PT:pt"
#I18N#		COUNTRY="pt"
#I18N#		LANG="pt_PT.UTF-8"
#I18N#		KEYTABLE="pt-latin1"
#I18N#		XKEYBOARD="pt"
#I18N#		KDEKEYBOARD="pt"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="de,us,fr"
#I18N#		TZ="Europe/Lisbon"
#I18N#		CONSOLEFONT="lat10-16"
#I18N#		;;
#I18N#	ru-legacy)
#I18N#		# Russian version
#I18N#		COUNTRY="ru"
#I18N#		LANG="ru_RU.KOI8-R"
#I18N#		KEYTABLE="ru"
#I18N#		XKEYBOARD="ru"
#I18N#		KDEKEYBOARD="ru"
#I18N#		CHARSET="koi8-r"
#I18N#		CONSOLEFONT="Cyr_a8x16"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="de,us,fr"
#I18N#		TZ="Europe/Moscow"
#I18N#		;;
#I18N#	ru-utf8|ru)
#I18N#		# Russian version
#I18N#		LANGUAGE="ru_RU:ru"
#I18N#		COUNTRY="ru"
#I18N#		LANG="ru_RU.UTF-8"
#I18N#		KEYTABLE="ru"
#I18N#		XKEYBOARD="ru"
#I18N#		KDEKEYBOARD="ru"
#I18N#		CHARSET="utf8"
#I18N#		CONSOLEFONT="Cyr_a8x16"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="de,us,fr"
#I18N#		TZ="Europe/Moscow"
#I18N#		;;
#I18N#	sk-legacy)
#I18N#		# Slovak version (guessed)
#I18N#		COUNTRY="sk"
#I18N#		LANG="sk"
#I18N#		KEYTABLE="sk-qwerty"
#I18N#		XKEYBOARD="sk"
#I18N#		KDEKEYBOARD="sk"
#I18N#		CHARSET="iso8859-2"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,de"
#I18N#		TZ="Europe/Bratislava"
#I18N#		CONSOLEFONT="iso02g"
#I18N#		;;
#I18N#	sk-utf8|sk)
#I18N#		# Slovak version (guessed)
#I18N#		LANGUAGE="sk_SK:sk"
#I18N#		COUNTRY="sk"
#I18N#		LANG="sk_SK.UTF-8"
#I18N#		KEYTABLE="sk-qwerty"
#I18N#		XKEYBOARD="sk"
#I18N#		KDEKEYBOARD="sk"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,de"
#I18N#		TZ="Europe/Bratislava"
#I18N#		CONSOLEFONT="iso02g"
#I18N#		;;
#I18N#	sl-legacy)
#I18N#		# Slovenian keyboard
#I18N#		LANGUAGE="sl"
#I18N#		COUNTRY="si"
#I18N#		LANG="sl_SI"
#I18N#		KEYTABLE="slovene"
#I18N#		XKEYBOARD="sl"
#I18N#		KDEKEYBOARD="si"
#I18N#		CHARSET="iso8859-2"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,de"
#I18N#		TZ="Europe/Ljubljana"
#I18N#		CONSOLEFONT="iso02g"
#I18N#		;;
#I18N#	sl-utf8|sl)
#I18N#		# Slovenian keyboard
#I18N#		LANGUAGE="sl_SI:sl"
#I18N#		COUNTRY="si"
#I18N#		LANG="sl_SI.UTF-8"
#I18N#		KEYTABLE="slovene"
#I18N#		XKEYBOARD="sl"
#I18N#		KDEKEYBOARD="si"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,de"
#I18N#		TZ="Europe/Ljubljana"
#I18N#		CONSOLEFONT="iso02g"
#I18N#		;;
#I18N#	tr-legacy)
#I18N#		# Turkish version (guessed)
#I18N#		COUNTRY="tr"
#I18N#		LANG="tr_TR"
#I18N#		KEYTABLE="tr_q-latin5"
#I18N#		XKEYBOARD="tr"
#I18N#		KDEKEYBOARD="tr"
#I18N#		CHARSET="iso8859-9"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,de,fr"
#I18N#		TZ="Europe/Istanbul"
#I18N#		;;
#I18N#	tr-utf8|tr)
#I18N#		# Turkish version (guessed)
#I18N#		LANGUAGE="tr_TR"
#I18N#		COUNTRY="tr"
#I18N#		LANG="tr_TR.UTF-8"
#I18N#		KEYTABLE="tr_q-latin5"
#I18N#		XKEYBOARD="tr"
#I18N#		KDEKEYBOARD="tr"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us,de,fr"
#I18N#		TZ="Europe/Istanbul"
#I18N#		;;
#I18N#	tw-legacy)
#I18N#		# Traditional Chinese version (thanks to Chung-Yen Chang)
#I18N#		COUNTRY="tw"
#I18N#		LANG="zh_TW.Big5"
#I18N#		LANGUAGE="zh_TW.Big5"
#I18N#		KEYTABLE="us"
#I18N#		XKEYBOARD="us"
#I18N#		KDEKEYBOARD="us"
#I18N#		# CHARSET="big5-0"
#I18N#		CHARSET="iso8859-1"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us"
#I18N#		XMODIFIERS="@im=xcin"
#I18N#		TZ="Asia/Taipei"
#I18N#		;;
#I18N#	tw-utf8|tw)
#I18N#		# Traditional Chinese version (thanks to Chung-Yen Chang)
#I18N#		LANGUAGE="zh_TW:zh"
#I18N#		COUNTRY="tw"
#I18N#		LANG="zh_TW.UTF-8"
#I18N#		KEYTABLE="us"
#I18N#		XKEYBOARD="us"
#I18N#		KDEKEYBOARD="us"
#I18N#		# CHARSET="big5-0"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us"
#I18N#		XMODIFIERS="@im=xcin"
#I18N#		TZ="Asia/Taipei"
#I18N#		;;
#I18N#	uk-legacy)
#I18N#		# British version
#I18N#		COUNTRY="uk"
#I18N#		LANG="en_GB"
#I18N#		LANGUAGE="en"
#I18N#		KEYTABLE="uk"
#I18N#		XKEYBOARD="uk"
#I18N#		KDEKEYBOARD="gb"
#I18N#		CHARSET="iso8859-1"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us"
#I18N#		TZ="Europe/London"
#I18N#		;;
#I18N#	uk-utf8|uk)
#I18N#		# British version UTF-8
#I18N#		LANGUAGE="en_GB:en"
#I18N#		COUNTRY="uk"
#I18N#		LANG="en_GB.UTF-8"
#I18N#		KEYTABLE="uk"
#I18N#		XKEYBOARD="uk"
#I18N#		KDEKEYBOARD="gb"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="us"
#I18N#		TZ="Europe/London"
#I18N#		;;
#I18N#	us-legacy|c)
#I18N#		# American version
#I18N#		LANGUAGE="us"
#I18N#		COUNTRY="us"
#I18N#		LANG="C"
#I18N#		KEYTABLE="us"
#I18N#		XKEYBOARD="us"
#I18N#		KDEKEYBOARD="us"
#I18N#		CHARSET="iso8859-1"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="de,fr"
#I18N#		TZ="America/New_York"
#I18N#		;;
#I18N#	us-utf8|us|*)
#I18N#		# American version UTF-8
#I18N#		LANGUAGE="en_US:en"
#I18N#		COUNTRY="us"
#I18N#		LANG="en_US.UTF-8"
#I18N#		KEYTABLE="us"
#I18N#		XKEYBOARD="us"
#I18N#		KDEKEYBOARD="us"
#I18N#		CHARSET="utf8"
#I18N#		# Additional KDE Keyboards
#I18N#		KDEKEYBOARDS="de,fr"
#I18N#		TZ="America/New_York"
#I18N#		;;
#I18N#esac
#I18N#
#I18N## Export it now, so error messages get translated, too
#I18N#export LANG COUNTRY CHARSET
#I18N#
#I18N## Allow keyboard override by boot commandline
#I18N#KKEYBOARD="$(getbootparam keyboard 2>/dev/null)"
#I18N#[ -n "$KKEYBOARD" ] && KEYTABLE="$KKEYBOARD"
#I18N#KXKEYBOARD="$(getbootparam xkeyboard 2>/dev/null)"
#I18N#if [ -n "$KXKEYBOARD" ]; then
#I18N#	XKEYBOARD="$KXKEYBOARD"
#I18N#	KDEKEYBOARD="$KXKEYBOARD"
#I18N#elif [ -n "$KKEYBOARD" ]; then
#I18N#	XKEYBOARD="$KKEYBOARD"
#I18N#	KDEKEYBOARD="$KKEYBOARD"
#I18N#fi

# Also read desired desktop, if any
DESKTOP="$(getbootparam desktop 2>/dev/null)"
# Allow only supported windowmanagers
case "$DESKTOP" in
	gnome|enlightenment|kde|larswm|xfce|xfce4|windowmaker|wmaker|icewm|fluxbox|twm|nx|rdp|kiosk)
		;;
	*)
		DESKTOP="kde"
		;;
esac

# Set hostname
hostname "$FLL_DISTRO_NAME"

# Set clock (Local time is more often used than GMT, so it is default)
UTC=""
checkbootparam utc 2>&1 >/dev/null && UTC="-u"
checkbootparam gmt 2>&1 >/dev/null && UTC="-u"

# hwclock uses the TZ variable
KTZ="$(getbootparam tz 2>/dev/null)"
[ -f "/usr/share/zoneinfo/$KTZ" ] && TZ="$KTZ"
export TZ
hwclock $UTC -s

# enable splash if possible
SPLASH=$(getbootparam "splash" 2>/dev/null)
[ -z "$SPLASH" ] && checkbootparam "splash" && SPLASH=on
[ "$SPLASH" = "off" ] && SPLASH=""

if [ -n "$SPLASH" ]; then
	OLDSPLASH=""
	checkbootparam "oldsplash" && OLDSPLASH="y"
	rm -f "$SPLASHY_PROGRESS_PIPE"
	RES=$(fbresolution 2>/dev/null)
	[ -z "$RES" ] && RES=1024x768
	if [ "$RES" = "1024x768" -o "$RES" = "800x600" ] && [ -x /sbin/splashy -a -z "$OLDSPLASH" ]; then
		[ -p /etc/splashy/splashy.fifo ] || /sbin/splashy boot
	fi
fi

update_progress()
{
	# be sure we are non-blocking
	if [ -p "$SPLASHY_PROGRESS_PIPE" ]; then
		(echo "$1" > "$SPLASHY_PROGRESS_PIPE") &
	elif [ -p /etc/splashy/splashy.fifo ]; then
		(echo "progress $1" > /etc/splashy/splashy.fifo) &
	fi
}

KERNEL="$(uname -r)"
echo " ${GREEN}Running Linux Kernel ${YELLOW}$KERNEL${GREEN}.${NORMAL}"

# / must be read-write in any case, starting from here
mount -o remount,rw / 2>/dev/null

if [ -n "$TZ" ]; then
	rm -f /etc/localtime
	cp "/usr/share/zoneinfo/$TZ" /etc/localtime
	rm -f /etc/timezone
	echo "$TZ" > /etc/timezone
fi

# Delete obsolete links and files before starting autoconfig
if ! checkbootparam "nohwsetup"; then
	rm -f	/dev/cdrom* /dev/cdwriter* /dev/dvdwriter* /dev/mouse* /dev/modem* /dev/scanner* \
		"$HWSETUP_I18N" "$HWSETUP_KEYBOARD" "$HWSETUP_MAIN" \
		2>/dev/null
fi

# override dpi setting
CUSTOM_DPI="$(getbootparam dpi 2>/dev/null)"

#I18N## Write KNOPPIX config files for other scripts to parse
#I18N## Standard variables/files
#I18N#echo "LANG=\"$LANG\""                  > "$HWSETUP_I18N"
#I18N#echo "COUNTRY=\"$COUNTRY\""           >> "$HWSETUP_I18N"
#I18N#echo "LANGUAGE=\"$LANGUAGE\""         >> "$HWSETUP_I18N"
#I18N#echo "CHARSET=\"$CHARSET\""           >> "$HWSETUP_I18N"
#I18N#echo "XMODIFIERS=\"$XMODIFIERS\""     >> "$HWSETUP_I18N"
#I18N##echo "TZ=\"$TZ\""                     >> "$HWSETUP_I18N"

#I18N## Default Keyboard layout for console and X
#I18N#echo "KEYTABLE=\"$KEYTABLE\""          > "$HWSETUP_KEYBOARD"
#I18N#echo "XKEYBOARD=\"$XKEYBOARD\""       >> "$HWSETUP_KEYBOARD"
#I18N#echo "KDEKEYBOARD=\"$KDEKEYBOARD\""   >> "$HWSETUP_KEYBOARD"
#I18N#echo "KDEKEYBOARDS=\"$KDEKEYBOARDS\"" >> "$HWSETUP_KEYBOARD"

# Desired desktop
echo "DESKTOP=\"$DESKTOP\""            > "$HWSETUP_DESKTOP"

#I18N## Write all, including non-standard variables, to "$HWSETUP_MAIN"
#I18N#echo "LANG=\"$LANG\""                  > "$HWSETUP_MAIN"
#I18N#echo "COUNTRY=\"$COUNTRY\""           >> "$HWSETUP_MAIN"
#I18N#echo "LANGUAGE=\"$LANGUAGE\""         >> "$HWSETUP_MAIN"
#I18N#echo "CHARSET=\"$CHARSET\""           >> "$HWSETUP_MAIN"
#I18N#echo "KEYTABLE=\"$KEYTABLE\""         >> "$HWSETUP_MAIN"
#I18N#echo "XKEYBOARD=\"$XKEYBOARD\""       >> "$HWSETUP_MAIN"
#I18N#echo "KDEKEYBOARD=\"$KDEKEYBOARD\""   >> "$HWSETUP_MAIN"
#I18N#echo "KDEKEYBOARDS=\"$KDEKEYBOARDS\"" >> "$HWSETUP_MAIN"
#I18N#echo "DESKTOP=\"$DESKTOP\""           >> "$HWSETUP_MAIN"
#I18N#echo "TZ=\"$TZ\""                     >> "$HWSETUP_MAIN"

# Write locale setting to default position
if [ -n "$LANG" ]; then
	rm -f /etc/default/locale
	echo -e "#  File generated by update-locale\nLANG=$LANG" > /etc/default/locale
fi

#I18N#ode console fix
#I18N#$(locale charmap)" = "UTF-8" ]; then
	unicode_start 2> /dev/null
#I18N#
#I18N#	unicode_stop 2> /dev/null
#I18N#fi

# Write DPI setting if specified
[ "$CUSTOM_DPI" ] && echo "CUSTOM_DPI=\"$CUSTOM_DPI\""  >> "$HWSETUP_MAIN"

# disable 915resolution hack
checkbootparam "no915res" && echo "NO915RES=\"yes\"" >> "$HWSETUP_MAIN"

# No kernel messages while probing modules
echo "0" > /proc/sys/kernel/printk

# Bring up loopback interface now
ifconfig lo 127.0.0.1 up

# CD Checker
if checkbootparam "testcd" || checkbootparam "testdvd"; then
	echo " ${BLUE}Checking CD data integrity as requested by '${CYAN}testcd${BLUE}' boot option.${NORMAL}"
	echo " ${BLUE}Reading files and checking against ${FLL_IMAGE_DIR}/md5sums, this may take a while...${NORMAL}"
	echo -n "${RED}"
	( cd /cdrom/ ; rm -f /tmp/md5sum.log ; LANG="$LANG" md5sum -c ${FLL_IMAGE_DIR}/md5sums 2>&1 | tee /tmp/md5sum.log )
	if [ "$?" = "0" ]; then
		echo " ${GREEN}Everything looks OK${NORMAL}"
	else
		echo "${RED} *** CHECKSUM FAILED FOR THESE FILES:                          ***"
		egrep -v '(^md5sum:|OK$)' /tmp/md5sum.log
		echo "${RED} *** DATA ON YOUR CD MEDIUM IS POSSIBLY INCOMPLETE OR DAMAGED, ***${NORMAL}"
		echo "${RED} *** OR YOUR COMPUTER HAS BAD RAM.                             ***${NORMAL}"
		echo -n "${CYAN}Hit return to contine, or press the reset button to quit.${NORMAL} "
		read a
	fi
fi

# Print CPU info
echo -n "${GREEN}"
awk -F: '/^processor/{printf " Processor"$2" is "};/^model name/{printf $2};/^vendor_id/{printf vendor};/^cpu MHz/{printf " %dMHz",int($2)};/^cache size/{printf ","$2" Cache"};/^$/{print ""}' /proc/cpuinfo 2>/dev/null
echo -n "${NORMAL}"

update_progress 10

# udev support
if checkbootparam "noudev"; then
	echo "${BLUE}Skipping udev as requested on boot commandline.${NORMAL}"
else
	echo " ${GREEN}Enable ${YELLOW}udev${GREEN}.${NORMAL}"
	mkdir -p /media
	if ! pidof udevd >&-; then
		RUNLEVEL=S /etc/init.d/udev start 2>&1 >/dev/null
		# load capability LSM (needed for hal)
		modprobe capability 2>&1 >/dev/null
		if [ -x /etc/init.d/dbus-1 ]; then
			/etc/init.d/dbus-1 start 2>&1 >/dev/null
		elif [ -x /etc/init.d/dbus ]; then
			/etc/init.d/dbus start 2>&1 >/dev/null
		fi
	fi
fi

if [ -n "$SPLASH" ]; then
	if ! [ -p /etc/splashy/splashy.fifo ]; then
		[ "$RES" = "1024x768" -a -x /etc/init.d/splash.sh ] && /etc/init.d/splash.sh start
	fi
fi

update_progress 20

# Mount /dev/pts
stringinfile "/dev/pts" /proc/mounts || mount -t devpts -o mode=0622 /dev/pts /dev/pts 2>/dev/null

# check if usbcore is already loaded.
USBCORE_TIMEOUT="$(getbootparam usbwait 2>/dev/null)"
[ -z "$USBCORE_TIMEOUT" ] && USBCORE_TIMEOUT=5
USBCORE_TIMEOUT=$((USBCORE_TIMEOUT))
[ $USBCORE_TIMEOUT -lt 0 -o $USBCORE_TIMEOUT -gt 60 ] && USBCORE_TIMEOUT=5

echo -n "${BLUE}Waiting for ${YELLOW}usbcore${BLUE}. ${NORMAL}"
for x in $(seq ${USBCORE_TIMEOUT}); do
	stringinfile "usbcore" /proc/modules && break
	echo -n "${BLUE}$((${USBCORE_TIMEOUT}-${x})) s${NORMAL}"
	for y in $(seq 10); do
		stringinfile "usbcore" /proc/modules && break
		sleep 0.1
	done
	for z in $(seq $((${#x}+2))); do echo -ne "\b \b"; done
done
stringinfile "usbcore" /proc/modules && echo "${GREEN}Done.${NORMAL}" || echo "${RED}Timeout reached.${NORMAL}"

# Activate usbfs
stringinfile "/proc/bus/usb" /proc/mounts || mount -o devmode=0666 -t usbfs /proc/bus/usb /proc/bus/usb 2>/dev/null

if [ -d /proc/acpi ]; then
	# ACPI
	if checkbootparam "noacpi"; then
		echo " ${BLUE}Skipping ACPI Bios detection as requested on boot commandline.${NORMAL}"
	else
		echo -n " ${GREEN}ACPI Bios found, activating modules:"
		found=""
		for a in /lib/modules/$KERNEL/kernel/drivers/acpi/*; do
			basename="${a##*/}"
			basename="${basename%%.*}"
			case "$basename" in
				*_acpi)
					egrep -qi "${basename%%_acpi}" /proc/acpi/dsdt 2>/dev/null || continue
					;;
			esac
			modprobe $basename 2>&1 >/dev/null && echo -n " ${YELLOW}$basename${GREEN}" && found="yes"
		done
		test -z "$found" && echo -n "${BLUE}(none)"
		echo "${NORMAL}"
		fuser -k /proc/acpi/event 2>&1 >/dev/null
		/etc/init.d/acpid start >/dev/null
	fi
else
	# APM
	if checkbootparam "noapm"; then
		echo " ${BLUE}Skipping APM Bios detection as requested on boot commandline.${NORMAL}"
	else
		modprobe apm power_off=1 2>&1 >/dev/null && test -x /etc/init.d/apmd && /etc/init.d/apmd start && echo " ${GREEN}APM Bios found, power management functions enabled.${NORMAL}"
	fi
fi

# First: PCMCIA Check/Setup
# This needs to be done before other modules are being loaded by hwsetup

if checkbootparam "nopcmcia"; then
	echo " ${BLUE}Skipping PCMCIA detection as requested on boot commandline.${NORMAL}"
else
	modprobe pcmcia_core 2>&1 >/dev/null

	# Try Cardbus or normal PCMCIA socket drivers
	modprobe 	yenta_socket 2>&1 >/dev/null || \
			modprobe i82365 2>&1 >/dev/null || \
			modprobe tcic 2>&1 >/dev/null 
	if [ "$?" = "0" ]; then
		if /etc/init.d/pcmciautils start 2>&1 >/dev/null; then
			echo " ${GREEN}PCMCIA started.${NORMAL}"
			sleep 4
		fi
	fi
fi

update_progress 40
# Second: Search & configure supported hardware
# Check for options relevant to hwsetup
NOSERIAL=""
checkbootparam noserial 2>&1 >/dev/null && NOSERIAL="yes"
[ -n "$NOSERIAL" ] && HWSETUP_NOSERIAL="-m"
# load serial module
modprobe 8250 2>&1 >/dev/null

# load psmouse module
modprobe psmouse 2>&1 >/dev/null
echo -n "${WHITE}"
if hwsetup -p $HWSETUP_NOSERIAL >/dev/null; then
	echo -n "${NORMAL}"
else
	echo " ${RED}Please check.${NORMAL}"
fi
update_progress 60

# activate PC Speaker
modprobe pcspkr 2>&1 >/dev/null

# Load fuse module
modprobe fuse 2>&1 >/dev/null

# activate input driver for char event devices
modprobe evdev 2>&1 >/dev/null

# dwl520e1 detection
rm -f /etc/modprobe.d/dwl520e1
if lspci -nv|grep 1260:3873 -A1|grep -q 1186:3700; then
	/usr/sbin/dwl520e1_fw_load 2>&1 >/dev/null
	echo 'install hostap_pci /sbin/modprobe --ignore-install hostap_pci && /usr/sbin/dwl520e1_fw_load 2>&1 >/dev/null' > /etc/modprobe.d/dwl520e1
fi

# ipw3945 detection
[ -e /sys/bus/pci/drivers/ipw3945/*/cmd ] && (pidof ipw3945d 2>&1 >/dev/null || /sbin/ipw3945d --quiet 2>&1 >/dev/null)

# Handle special options for ALSA sound drivers
rm -f /etc/modprobe.d/alsa-special
SYS=$(cut -f2 -d: /sys/devices/pci*/{,*/}*/modalias 2>/dev/null)
ALSA_SPECIAL=""
for sysid in $SYS; do
	# ALSA_SPECIAL is [kernel module with _ not -] [needed options]
	case "$sysid" in
		v000010DEd0000026Csv00001043sd000081CBbc*)
			# ASUS M2NPV-VM
			ALSA_SPECIAL="snd_hda_intel position_fix=1 model=3stack"
			break
			;;
		v00008086d000027D8sv00001854sd0000005Fbc*)
			# LG Electronics P1-J302E1
			ALSA_SPECIAL="snd_hda_intel model=lg"
			break
			;;
		v00008086d0000284Bsv00008086sd0000284Bbc*)
			# MSI MS-7235
			ALSA_SPECIAL="snd_hda_intel position_fix=1"
			break
			;;
	esac
done
if [ -n "$ALSA_SPECIAL" ]; then
	echo options $ALSA_SPECIAL > /etc/modprobe.d/alsa-special
	if [ -d /sys/module/${ALSA_SPECIAL%% *} ]; then
		rmmod ${ALSA_SPECIAL%% *}
		modprobe $ALSA_SPECIAL
	fi
fi

# Read in what hwsetup has found
[ -f "$HWSETUP_MAIN" ] && . "$HWSETUP_MAIN"

# Workaround for new mouse detection
if [ -f "$HWSETUP_MOUSE" ]; then
	. "$HWSETUP_MOUSE"
	if [ "$MOUSETYPE" = "ps2" ]; then
		ln -sf /dev/psaux /dev/mouse
		perl -pi -e "s|/dev/input/mice|/dev/psaux|" "$HWSETUP_MOUSE" "$HWSETUP_MAIN"
		. "$HWSETUP_MOUSE"
		. "$HWSETUP_MAIN"
	fi
fi
       
# Mouse
if [ -n "$MOUSE_DEVICE" ]; then
	echo " ${GREEN}Mouse is ${YELLOW}${MOUSE_FULLNAME}${GREEN} at ${MAGENTA}${MOUSE_DEVICE}${NORMAL}"
fi

# Soundcard
if [ -n "$SOUND_FULLNAME" -o -n "$SOUND_DRIVER" ]; then
	SOUNDCARD="$SOUND_DRIVER"
	echo -n " ${GREEN}Soundcard:"
	[ -n "$SOUND_FULLNAME" ] && echo -n " ${YELLOW}$SOUND_FULLNAME${GREEN}"
	[ -n "$SOUNDCARD" ] && echo -n " driver=${MAGENTA}$SOUNDCARD"
	echo "${NORMAL}"
fi

# Get max. sound volume
VOL="$(getbootparam vol 2>/dev/null)"
[ -z "$VOL" ] && VOL=50
VOL=$((VOL))
[ $VOL -lt 0 -o $VOL -gt 100 ] && VOL=50

# Fast ALSA detection

if [[ "$SOUND_DRIVER" = snd-* ]]; then
	echo alias snd-card-0 $SOUND_DRIVER > /etc/modprobe.d/sound
	echo options $SOUND_DRIVER index=0 >> /etc/modprobe.d/sound
	#set_mixers
	aumix -m 0 -v $VOL -w $VOL -c $VOL 2>&1 >/dev/null # set pcm & master & cd to $VOL, micro to 0
fi

#I18N## Read default keyboard from config file.
#I18N## There seems to be no reliable autoprobe possible.
#I18N#[ -f "$HWSETUP_KEYBOARD" ] && . "$HWSETUP_KEYBOARD"
#I18N## Set default keyboard before interactive setup
#I18N#[ -n "$KEYTABLE" ] && loadkeys -q $KEYTABLE
#I18N#[ -n "$CONSOLEFONT" ] && consolechars -f $CONSOLEFONT

# Check for blind option or brltty
BLIND=""
checkbootparam "blind" && BLIND="yes"
BRLTTY="$(getbootparam brltty 2>/dev/null)"

if [ -n "$BLIND" -o -n "$BRLTTY" ]; then
	if [ -x /sbin/brltty ]; then
		# Blind option detected, start brltty now.
		CMD=brltty
		BRLTYPE=""
		BRLDEV=""
		BRLTEXT=""
		if [ -n "$BRLTTY" ]; then
			# Extra options
			BRLTYPE="${BRLTTY%%,*}"
			R="${BRLTTY#*,}"
			if [ -n "$R" -a "$R" != "$BRLTTY" ]; then
				BRLTTY="$R"
				BRLDEV="${BRLTTY%%,*}"
				R="${BRLTTY#*,}"
				if [ -n "$R" -a "$R" != "$BRLTTY" ]; then
					BRLTTY="$R"
					BRLTEXT="${BRLTTY%%,*}"
					R="${BRLTTY#*,}"
				fi
			fi
		fi
		[ -n "$BRLTYPE" ] && CMD="$CMD -b $BRLTYPE"
		[ -n "$BRLDEV" ] && CMD="$CMD -d $BRLDEV"
		[ -n "$BRLTEXT" ] && CMD="$CMD -t $BRLTEXT"
		echo " ${BLUE}Starting braille-display manager: ${GREEN}${CMD}${BLUE}.${NORMAL}"
		( exec $CMD & )
		sleep 2
	fi
fi

if [ -n "$INTERACTIVE" ]; then
	# Interactive configuration
	echo "${BLUE}Entering interactive configuration second stage.${NORMAL}"

	echo " ${GREEN}Your console keyboard defaults to: ${MAGENTA}${KEYTABLE}"
	echo -n "${CYAN}Do you want to (re)configure your console keyboard?${NORMAL} [Y/n] "
	read a
	[ "$a" != "n" ] && /usr/sbin/kbdconfig
	# kbdconfig already loads the keyboard if modified.

	echo -n "${CYAN}Do you want to (re)configure your soundcard?${NORMAL} [Y/n] "
	read a
	[ "$a" != "n" ] && sndconfig && ( exec aumix -m 0 2>&1 >/dev/null & )

	if [ -n "$MOUSE_FULLNAME" -o -n "$MOUSE_DEVICE" ]; then
		echo -n " ${GREEN}Your mouse has been autodetected as: ${MAGENTA}"
		ls -l /dev/mouse | awk '{print $9 " " $10 " " $11}'
		echo -n "${NORMAL}"
	fi

	echo -n "${CYAN}Do you want to (re)configure your mouse?${NORMAL} [Y/n] "
	read a
	[ -f "$HWSETUP_MOUSE" ] && . "$HWSETUP_MOUSE"
	[ "$a" != "n" ] && mouseconfig
fi

update_progress 80

# KNOPPIX automatic XFree86 Setup
if ! checkbootparam "nomkxf86config"; then
	[ -x /usr/sbin/mkxf86config ] && /usr/sbin/mkxf86config
fi

# Read in changes
[ -f "$HWSETUP_MAIN" ] && . "$HWSETUP_MAIN"

if [ -n "$INTERACTIVE" ]; then
	echo -n "${CYAN}Do you want to (re)configure your graphics (X11) subsystem?${NORMAL} [Y/n] "
	read a
	[ "$a" != "n" ] && xf86cfg -textmode -xf86config "$X_CONF" >/dev/console 2>&1 </dev/console
	echo " ${GREEN}Interactive configuration finished. Everything else should be fine for now.${NORMAL}"
fi

if [ -n "$USE_ALSA" -a -x /etc/init.d/alsa-autoconfig ]; then
	[ -n "$SOUND_DRIVER" ] && rmmod -r "$SOUND_DRIVER" 2>&1 >/dev/null
	# Export ALSA_CARD cariable to init script
	case "$ALSA_CARD" in
		auto*)
		ALSA_CARD=""
		;;
	esac
	ALSA_CARD="$ALSA_CARD" /etc/init.d/alsa-autoconfig
	# Something went wrong ?
	[ ! -r /etc/modules.conf ] && ln -sf /${FLL_MOUNTPOINT}/etc/modules.conf /etc/modules.conf
fi

# Start FC detection on vt10
NOFC=""
checkbootparam "nofc" && NOFC="yes"
[ -e /etc/drdsl/modules.inc ] && NOFC="yes"
if [ -z "$NOFC" ]; then
	echo " ${GREEN}Starting ${YELLOW}FC${GREEN} detection on ${YELLOW}vt10${GREEN}.${NORMAL}"
	if [ -x /usr/sbin/detect-fc ]; then
		open -c 10 /usr/sbin/detect-fc
	elif [ -x /usr/local/bin/detect-fc.bash ]; then
		open -c 10 /usr/local/bin/detect-fc.bash
	fi
fi

RUNLEVEL="$(runlevel)"

# Add cdrom devices to /etc/fstab
for c in $(ls -d /dev/cdrom* 2>/dev/null); do
	m=${c#/dev}
	[ "$m" = "/cdrom" ] && m="/cdrom0"
	[ -d /media$m ] || mkdir -p /media$m 
	#stringinfile "$c" "/etc/fstab" || printf "%-15s %-15s %-7s %-15s %-7s %s\n" "$c" "/media$m" "udf,iso9660" "user,noauto" "0" "0" >> /etc/fstab
	stringinfile "/dev/$(readlink $c)" "/etc/fstab" || printf "%-15s %-15s %-7s %-15s %-7s %s\n" "/dev/$(readlink $c)" "/media$m" "udf,iso9660" "user,noauto" "0" "0" >> /etc/fstab
done

# Add floppy devices to /etc/fstab
for f in $(ls -d /sys/block/fd* 2>/dev/null); do
	[ -d /media/floppy${f#/sys/block/fd} ] || mkdir -p /media/floppy${f#/sys/block/fd} 
	stringinfile "$f" "/etc/fstab" || printf "%-15s %-15s %-7s %-15s %-7s %s\n" "/dev${f#/sys/block}" "/media/floppy${f#/sys/block/fd}" "auto" "rw,user,noauto" "0" "0" >> /etc/fstab
done

NOSWAP=""
checkbootparam "noswap" && NOSWAP="yes"

# Collect partitions from /proc/partitions
partitions=""
while read major minor blocks partition relax; do
	partition="${partition##*/}"
	[ -z "$partition" -o ! -e "/dev/$partition" ] && continue
	case "$partition" in
		hd?)
			# IDE Harddisk, entire disk
			;;
		sd?)
			# SCSI Harddisk, entire disk
			;;
		[hs]d*)
			# IDE or SCSI disk partition
			partitions="$partitions /dev/$partition"
			;;
	esac
done <<EOT
$(awk 'BEGIN{old="__start"}{if($0==old){exit}else{old=$0;if($4&&$4!="name"){print $0}}}' /proc/partitions)
EOT

# Disable DMA for all IDE drives now if not enabled (and if not already done by linuxrc).
# This is already done by linuxrc now.
# However, for a harddisk-installed version, we are doing it again here.
if checkbootparam "nodma"; then
	for d in $(cd /proc/ide 2>/dev/null && echo hd[a-z]); do
		if test -d /proc/ide/$d; then
			if egrep -q 'using_dma[ \t]+1' /proc/ide/$d/settings 2>/dev/null; then
				MODEL="$(cat /proc/ide/$d/model 2>/dev/null)"
				test -z "$MODEL" && MODEL="[GENERIC IDE DEVICE]"
				echo "${BLUE}Disabling DMA acceleration for: ${MAGENTA}$d 	${YELLOW}[${MODEL}]${NORMAL}"
				echo "using_dma:0" >/proc/ide/$d/settings
			fi
		fi
	done
fi

# Start creating /etc/fstab with HD partitions and USB SCSI devices now
if checkbootparam "nofstab"; then
	echo " ${BLUE}Skipping /etc/fstab creation as requested on boot commandline.${NORMAL}"
else
	echo -n "${BLUE}Scanning for Harddisk partitions and creating ${YELLOW}/etc/fstab${BLUE}... "
	[ -d /${FLL_MOUNTPOINT} ] && rebuildfstab -r -u ${FLL_LIVE_USER} -g $(getent passwd "$FLL_LIVE_USER" | cut -d\: -f 4) >/dev/null 2>/dev/null || rebuildfstab -r 2>&1 >/dev/null
	if [ -e /var/run/rebuildfstab.pid ]; then
		# Another instance of rebuildfstab, probably from hotplug, is still running, so just wait.
		sleep 8
	fi
	echo "${GREEN}Done.${NORMAL}"
fi

if [ -n "$partitions" ]; then
	while read p m f relax; do
		case "$p" in
			*fd0*|*proc*|*pts*|*sys*|*cdrom*|\#*)
			continue
			;;
		esac
		options="users,exec"
		fnew=""
		case "$f" in
			swap)
				if [ -n "$NOSWAP" ]; then
					echo "${BLUE}Ignoring swap partition ${MAGENTA}$p${BLUE} as requested.${NORMAL}"
				else
					echo "${BLUE}Using swap partition ${MAGENTA}$p${BLUE}.${NORMAL}"
					swapon $p 2>/dev/null
				fi
				continue
			;;
		esac
		# Create mountdir if not already present
		d="/media/${p##*/}" ; [ -d "$d" ] || mkdir -p "$d"
		case "$f" in
			vfat|msdos)
				if [ -z "$NOSWAP" ] && mount -o uid=${FLL_LIVE_USER},gid=$(getent passwd "$FLL_LIVE_USER" | cut -d\: -f 4),ro -t $f $p $d 2>/dev/null; then
					if [ -f $d/${FLL_DISTRO_NAME}.swp ]; then
						mount -o remount,rw $d
						if swapon $d/${FLL_DISTRO_NAME}.swp 2>/dev/null; then
							echo "${BLUE}Using ${FLL_DISTRO_NAME} swapfile ${MAGENTA}$d/${FLL_DISTRO_NAME}.swp${BLUE}.${NORMAL}"
							mount -o remount,ro $d 2>/dev/null
							fnew="$d/${FLL_DISTRO_NAME}.swp none            swap    sw              0       0"
							stringinfile "$fnew" "/etc/fstab" || echo "$fnew" >> /etc/fstab
						else
							umount $d
						fi
					else
						umount $d
					fi
				fi
				;;
		esac
	done <<EOT
$(cat /etc/fstab)
EOT
fi
update_progress 90

# New: Interactively create swapfiles on DOS partitions
# (if necessary and possible)
FREEMEM="$(awk 'BEGIN{m=0};/MemFree|Cached|SwapFree/{m+=$2};END{print m}' /proc/meminfo)"

if [ "$FREEMEM" -lt 80000 -a -x /usr/bin/kdeinit -a -x /usr/sbin/mkdosswapfile ]; then
	case "$LANG" in
		de*)
			LOWMEM="Ihr Rechner verfÃ¼gt nur Ã¼ber ${FREEMEM}kB freien RAM-Speicher. Dies ist fÃ¼r das Arbeiten mit Linux zwar generell ausreichend, aber leider nicht genug, um grÃ¶ÃŸere Anwendungen wie KDE oder Office-Pakete zu starten. Sie kÃ¶nnen im nÃ¤chsten Schritt versuchen, eine sog. Auslagerungsdatei auf einer DOS-Partition (sofern vorhanden) einzurichten."
			;;
		*)
			LOWMEM="There are only ${FREEMEM}kB of RAM available in your computer. While this is usually sufficient for working under Linux, it is unfortunately not enough for starting bigger applications like KDE, or office suites. You can try to create a so-called swapfile on an existing DOS-Partition (if available) in the next step."
			;;
	esac
		dialog --msgbox "$LOWMEM" 12 65 </dev/console >/dev/console 2>&1 
		/usr/sbin/mkdosswapfile </dev/console >/dev/console 2>&1 
fi

# Fat-Client-Version: DHCP Broadcast for IP address
if checkbootparam "nodhcp"; then
	echo " ${BLUE}Skipping DHCP broadcast/network detection as requested on boot commandline.${NORMAL}"
else
	NETDEVICES="$(awk -F: '/eth.:|tr.:/{print $1}' /proc/net/dev 2>/dev/null)"
	for DEVICE in $NETDEVICES; do
		echo -n " ${GREEN}Network device ${MAGENTA}$DEVICE${GREEN} detected, DHCP broadcasting for IP.${NORMAL}"
		trap 2 3 11
		pump -i $DEVICE 2>&1 >/dev/null &
		trap "" 2 3 11
		sleep 1
		echo " ${BLUE}(Backgrounding)${NORMAL}"
	done
fi

if [ -r "${FLL_WALLPAPER}" ]; then
	# Set $BACKGROUND according to distro defaults
	BACKGROUND="${FLL_WALLPAPER}"
else
	# Search for custom background image for KDE/GNOME/X
	for i in /cdrom/${FLL_IMAGE_DIR}/background /usr/share/wallpapers/sidux; do
		for j in png jpg gif; do
			BACKGROUND="$i.$j"
			[ -e "$BACKGROUND" ] && break 2
		done
	done
fi
echo 'BACKGROUND="'"$BACKGROUND"'"' >> "$HWSETUP_MAIN"

findfile()
{
	FOUND=""
	# search all partitions for a file in the root directory
	for i in /media/[sh]d[a-z] /media/[sh]d[a-z][1-9] /media/[sh]d[a-z][1-9]?*; do
		# See if it's already mounted
		[ -f "$i/$1" ] &&  { echo "$i/$1"; return 0; }
		if [ -d "$i" ] && mount -r "$i" 2>/dev/null; then
			[ -f "$i/$1" ] && FOUND="$i/$1"
			umount -l "$i" 2>/dev/null
			[ -n "$FOUND" ] && { echo "$FOUND"; return 0; }
		fi
	done
	return 2
}

# Load aes and cryptoloop
modprobe aes 2>/dev/null
modprobe cryptoloop 2>/dev/null

# Try to mount this filesystem read-only, without or with encryption
trymount()
{
	# Check if already mounted
	case "$(cat /proc/mounts)" in
		*\ $2\ *)
			return 0
			;;
	esac

	# Apparently, mount-aes DOES autodetect AES loopback files.
	[ -b "$1" ] && { mount -t auto -o ro "$1" "$2" 2>/dev/null; RC="$?"; }

	# We need to mount crypto-loop files with initial rw support
	[ -f "$1" ] && { mount -t auto -o loop,rw "$1" "$2" 2>/dev/null; RC="$?"; }
	# Mount succeeded?
	[ "$RC" = "0" ] && return 0
	echo ""
	echo "${CYAN}Filesystem not autodetected, trying to mount $1 with AES256 encryption${NORMAL}"
	a="y"
	while [ "$a" != "n" -a "$a" != "N" ]; do
		# We need to mount crypto-loop files with initial rw support
		mount -t auto -o loop,rw,encryption=AES256 "$1" "$2" && return 0
		echo -n "${RED}Mount failed, retry? [Y/n] ${NORMAL}"
		read a
	done
	return 1
}

# Unionfs
getfiledev()
{
	filedev="$(echo $MYPARAM | grep ^/media/ | tail -n 1 | sed s/\\/media\\/\\\([^\\/]\\+\\\).*/\\/dev\\/\\\1/)"
	[ -z "$filedev" ] && filedev="$(echo $MYPARAM | grep ^/dev/ | tail -n 1 | sed s/\\/dev\\/\\\([^\\/]\\+\\\).*/\\/dev\\/\\\1/)"
}

getfilepath()
{
	filepath="$(echo $MYPARAM | grep ^/media/ | sed s/\\/media\\/\\\([^\\/]\\+\\\)\\///)"
	[ -z "$filepath" ] && filepath="$(echo $MYPARAM | grep ^/dev/ | sed s/\\/dev\\/\\\([^\\/]\\+\\\)\\///)"
}

# Move up with other cheats code later
checkbootparam noconfigall && NOCONFIGCD="Y" && NOCONFIGHOME="Y" && NOCONFIGCHEAT="Y"
checkbootparam noconfigcd && NOCONFIGCD="Y"
checkbootparam noconfighome && NOCONFIGHOME="Y"
checkbootparam noconfigcheat && NOCONFIGCHEAT="Y"

if [ -z "$NOCONFIGCD" ]; then
	# Check for extra shellscript on CD-Rom (/cdrom/${FLL_IMAGE_DIR}/knoppix.sh)
	MYCONFIG="$(ls -1 /cdrom/${FLL_IMAGE_DIR}/ | grep -i "^${FLL_DISTRO_NAME}\\.sh$" 2>/dev/null)"
	if [ -n "$MYCONFIG" -a -f "$MYCONFIG" -a -z "$NOCONFIGCD" ]; then
		echo ""
		echo " ${GREEN}${FLL_DISTRO_NAME} Configuration file found on CD, executing ${MAGENTA}$MYCONFIG${GREEN}.${NORMAL}"
		echo "6" > /proc/sys/kernel/printk
		. "$MYCONFIG" /cdrom/${FLL_IMAGE_DIR} || true
		echo "0" > /proc/sys/kernel/printk
	fi
fi

# Check for persistent homedir option and eventually mount /home from there,
# or use a loopback file.
HOMEDIR="$(getbootparam home)"
MYHOMEDEVICE=""
MYHOMEMOUNTPOINT=""
MYHOMEDIR=""
if [ -n "$HOMEDIR" ]; then
	case "$HOMEDIR" in
		/dev/*)
			MYHOMEDEVICE="${HOMEDIR##/dev/}"
			MYHOMEDEVICE="/dev/${MYHOMEDEVICE%%/*}"
			MYHOMEMOUNTPOINT=$(grep $MYHOMEDEVICE /proc/mounts | cut -d' ' -f2)
			[ -z "$MYHOMEMOUNTPOINT" ] && MYHOMEMOUNTPOINT="/media/${MYHOMEDEVICE##/dev/}"
			MYHOMEDIR="/media/${HOMEDIR##/dev/}"
			;;
		/media/*)
			MYHOMEDEVICE="${HOMEDIR##/media/}"
			MYHOMEDEVICE="/dev/${MYHOMEDEVICE%%/*}"
			MYHOMEMOUNTPOINT=$(grep $MYHOMEDEVICE /proc/mounts | cut -d' ' -f2)
			[ -z "$MYHOMEMOUNTPOINT" ] && MYHOMEMOUNTPOINT="/media/${MYHOMEDEVICE##/dev/}"
			MYHOMEDIR="$HOMEDIR"
			;;
		[Aa][Uu][Tt][Oo]|[Ss][Cc][Aa][Nn]|[Ff][Ii][Nn][Dd])
			MYHOMEDIR="$(findfile $FLL_PERSISTENT_HOME)"
			MYHOMEDEVICE="${MYHOMEDIR##/media/}"
			MYHOMEDEVICE="/dev/${MYHOMEDEVICE%%/*}"
			MYHOMEMOUNTPOINT=$(grep $MYHOMEDEVICE /proc/mounts | cut -d' ' -f2)
			[ -z "$MYHOMEMOUNTPOINT" ] && MYHOMEMOUNTPOINT="/media/${MYHOMEDEVICE##/dev/}"
			;;
		*)
			echo "${CRE}${RED}Invalid ${CYAN}home=${RED} option '$HOMEDIR' specified (must start with /dev/ or /media/ or 'scan').${NORMAL}"
			echo "${CRE}${RED}Option ignored.${NORMAL}"
			;;
	esac
fi

if [ -n "$MYHOMEDIR" ]; then
	if trymount "$MYHOMEDEVICE" "$MYHOMEMOUNTPOINT"; then
		[ -f "$MYHOMEMOUNTPOINT/$FLL_PERSISTENT_HOME" ] && MYHOMEDIR="$MYHOMEMOUNTPOINT/$FLL_PERSISTENT_HOME"
		while read device mountpoint fs relax; do
			case "$mountpoint" in
				*$MYHOMEMOUNTPOINT*)
					case "$fs" in 
						*[Nn][Tt][Ff][Ss]*)
							umount "$MYHOMEMOUNTPOINT"; echo " ${RED}ERROR: WON'T MOUNT NTFS FILESYSTEM ON $MYHOMEDEVICE READ/WRITE!"
							break
							;;
						*[Ff][Aa][Tt]*)
							# Note: This currently won't work with encrypted partitions
							mount -o remount,rw,uid=${FLL_LIVE_USER},gid=$(getent passwd "$FLL_LIVE_USER" | cut -d\: -f 4),umask=002,shortname=mixed,quiet "$MYHOMEDEVICE" "$MYHOMEMOUNTPOINT"
							if [ ! -f "$MYHOMEDIR" ]; then
								echo " ${RED}WARNING: FAT32 is not a good filesystem option for /home/${FLL_LIVE_USER} (missing socket/symlink support).${NORMAL}"
								echo " ${RED}WARNING: Better use an ext2 loopback file on this device, and boot with home=$MYHOMEDEVICE/$FLL_PERSISTENT_HOME.${NORMAL}"
							fi
						;;
					esac
					if mount -o remount,rw "$MYHOMEMOUNTPOINT"; then
						echo -n " ${GREEN}Mounting ${YELLOW}$MYHOMEDIR${GREEN} as ${YELLOW}/home/${FLL_LIVE_USER}${GREEN}... "
						if [ -f "$MYHOMEDIR" ]; then
							# It's a loopback file, mount it over the /home/${FLL_LIVE_USER} directory
							trymount "$MYHOMEDIR" /home/${FLL_LIVE_USER}
							RC="$?"
							[ "$RC" = "0" ] && ERROR="$(mount -o remount,rw /home/${FLL_LIVE_USER} 2>&1)"
							RC="$?"
						else
							# Do a --bind mount
							ERROR="$(mount --bind "$MYHOMEDIR" /home/${FLL_LIVE_USER} 2>&1)"
							RC="$?"
						fi
						[ "$RC" = "0" ] && echo "${GREEN}/home/${FLL_LIVE_USER} mounted OK.${NORMAL}" || { echo "${RED}FAILED."; echo "$ERROR${NORMAL}"; }
					fi
					break
					;;
			esac
		done <<EOT
$(cat /proc/mounts)
EOT
	fi
fi

if [ -z "$NOCONFIGCHEAT" ]; then
	# Check for configuration floppy add-on if not running from HD
	if [ -n "$MYCONF" ]; then
		FOUND_CONFIG=""
		if [ -n "$MYCONFDIR" ]; then
			case "$MYCONFDIR" in
				/dev/*)
					MYCONFDEVICE="${MYCONFDIR##/dev/}"
					MYCONFDEVICE="/dev/${MYCONFDEVICE%%/*}"
					MYCONFMOUNTPOINT="/media/${MYCONFDEVICE##/dev/}"
					MYCONFDIR="/media/${MYCONFDIR##/dev/}"
					;;
				/media/*)
					MYCONFDEVICE="${MYCONFDIR##/media/}"
					MYCONFDEVICE="/dev/${MYCONFDEVICE%%/*}"
					MYCONFMOUNTPOINT="/media/${MYCONFDEVICE##/dev/}"
					;;
				[Aa][Uu][Tt][Oo]|[Ss][Cc][Aa][Nn]|[Ff][Ii][Nn][Dd])
					MYCONFDIR="$(findfile knoppix.sh)"
					if [ -n "$MYCONFDIR" ]; then
						MYCONFDEVICE="${MYCONFDIR##/media/}"
						MYCONFDEVICE="/dev/${MYCONFDEVICE%%/*}"
						MYCONFMOUNTPOINT="/media/${MYCONFDEVICE##/dev/}"
						MYCONFDIR="${MYCONFMOUNTPOINT}"
					else
						FOUND_CONFIG="none"
					fi
					;;
				*)
					echo "${CRE}${RED}Invalid configdir '$MYCONFDIR' specified (must start with /dev/ or /media/ or 'scan').${NORMAL}"
					echo "${CRE}${RED}Option ignored.${NORMAL}"
					FOUND_CONFIG="invalid"
					;;
			esac
		else
			MYCONFDEVICE="/dev/fd0"
			MYCONFMOUNTPOINT="/media/floppy0"
			MYCONFDIR="/media/floppy0"
		fi

		if [ -z "$FOUND_CONFIG" ]; then
			echo -n "${CRE}${BLUE}Checking ${MAGENTA}${MYCONFDIR}${BLUE} for ${FLL_DISTRO_NAME} configuration files...${NORMAL}"
			if trymount "$MYCONFDEVICE" "$MYCONFMOUNTPOINT"; then
				MYCONFIG="$(ls -1d $MYCONFDIR/[Kk][Nn][Oo][Pp][Pp][Ii][Xx].[Ss][Hh] 2>/dev/null)"
				[ -z "$MYCONFIG" ] && MYCONFIG="$(ls -1d $MYCONFDIR/[Kk][Aa][Nn][Oo][Tt][Ii][Xx].[Ss][Hh] 2>/dev/null)"
				if [ -n "$MYCONFIG" -a -f "$MYCONFIG" ]; then
					echo ""
					FOUND_CONFIG="yes"
					echo " ${GREEN}Found, now executing ${MAGENTA}$MYCONFIG${GREEN}.${NORMAL}"
					echo "6" > /proc/sys/kernel/printk
					. "$MYCONFIG" "$MYCONFDIR" || true
					echo "0" > /proc/sys/kernel/printk
				fi
				umount "$MYCONFMOUNTPOINT" 2>/dev/null
			fi
		fi
		[ -n "$FOUND_CONFIG" ] || echo " ${BLUE}Not present.${NORMAL}"
	fi
fi

# old .knoppix.sh
if [ -z "$NOCONFIGHOME" -a -f /home/${FLL_LIVE_USER}/.[Kk][Nn][Oo][Pp][Pp][Ii][Xx].[Ss][Hh] ]; then
	MYCONFIG="$(ls -1d /home/${FLL_LIVE_USER}/.[Kk][Nn][Oo][Pp][Pp][Ii][Xx].[Ss][Hh] 2>/dev/null)"
	echo " ${GREEN}Found, now executing ${MAGENTA}$MYCONFIG${GREEN}.${NORMAL}"
	echo "6" > /proc/sys/kernel/printk
	. "$MYCONFIG" "/home/${FLL_LIVE_USER}" || true
	echo "0" > /proc/sys/kernel/printk	
fi

# new .kanotix.sh
if [ -z "$NOCONFIGHOME" -a -f /home/${FLL_LIVE_USER}/.[Kk][Aa][Nn][Oo][Tt][Ii][Xx].[Ss][Hh] ]; then
	MYCONFIG="$(ls -1d /home/${FLL_LIVE_USER}/.[Kk][Aa][Nn][Oo][Tt][Ii][Xx].[Ss][Hh] 2>/dev/null)"
	echo " ${GREEN}Found, now executing ${MAGENTA}$MYCONFIG${GREEN}.${NORMAL}"
	echo "6" > /proc/sys/kernel/printk
	. "$MYCONFIG" "/home/${FLL_LIVE_USER}" || true
	echo "0" > /proc/sys/kernel/printk	
fi

# modem detection
if ! checkbootparam "nomodem"; then
	if lspci|grep Intel|grep -q "AC'97 Modem Controller"; then
		/etc/init.d/sl-modem-daemon start 2>&1 >/dev/null
		grep -q ^sl-modem-daemon "$HWSETUP_SERVICES" 2>&1 >/dev/null || echo sl-modem-daemon >> "$HWSETUP_SERVICES"
	fi
fi

# powernow detection
if ! checkbootparam "nopowernow"; then
	POWERNOW=""
	grep -iq "Mobile AMD Athlon(tm) XP" /proc/cpuinfo && POWERNOW="powernow-k7"
	grep -iq "AMD Athlon(tm) 64 Processor" /proc/cpuinfo && POWERNOW="powernow-k8"
	grep -iq "AMD Athlon(tm) 64 X2 Dual Core Processor" /proc/cpuinfo && POWERNOW="powernow-k8"
	grep -iq "AMD Sempron(tm) Processor" /proc/cpuinfo && POWERNOW="powernow-k8"
	grep -iq "AMD Turion(tm) 64" /proc/cpuinfo && POWERNOW="powernow-k8"
	grep -iq "Intel(R) Pentium(R) M processor" /proc/cpuinfo && POWERNOW="speedstep-centrino"
	#grep -iq "Intel(R) Celeron(R) M processor" /proc/cpuinfo && POWERNOW="speedstep-centrino"
	grep -qi [ETLU][1-9][0-9][05]0 /proc/cpuinfo && POWERNOW="speedstep-centrino"
	grep -qi "Core" /proc/cpuinfo && POWERNOW="speedstep-centrino"
	grep -iq "Mobile Intel(R) Pentium(R) 4" /proc/cpuinfo && POWERNOW="speedstep-ich"
	grep -iq "VIA Nehemiah" /proc/cpuinfo && POWERNOW="longhaul"
	if [ "$POWERNOW" ]; then
		echo " ${GREEN}Enable ${YELLOW}Powernow${GREEN}.${NORMAL}"
		modprobe $POWERNOW 2>&1 >/dev/null
		if [ -x /etc/init.d/powernowd ]; then
			/etc/init.d/powernowd start 2>&1 >/dev/null
			grep -q ^powernowd "$HWSETUP_SERVICES" 2>&1 >/dev/null || echo powernowd >>"$HWSETUP_SERVICES"
		fi
		if [ -x /etc/init.d/powersaved ]; then
			/etc/init.d/powersaved start 2>&1 >/dev/null
			grep -q ^powersaved "$HWSETUP_SERVICES" 2>&1 >/dev/null || echo powersaved >>"$HWSETUP_SERVICES"
		fi
	fi
else
	echo "${BLUE}Skipping Powernow detection as requested on boot commandline.${NORMAL}"
fi

# MS MM keyboard add-on
# fix
setkeycodes e001 126 2>&1 >/dev/null
setkeycodes e059 127 2>&1 >/dev/null
# fn keys
setkeycodes e03b 59 2>&1 >/dev/null
setkeycodes e008 60 2>&1 >/dev/null
setkeycodes e007 61 2>&1 >/dev/null
setkeycodes e03e 62 2>&1 >/dev/null
setkeycodes e03f 63 2>&1 >/dev/null
setkeycodes e040 64 2>&1 >/dev/null
setkeycodes e041 65 2>&1 >/dev/null
setkeycodes e042 66 2>&1 >/dev/null
setkeycodes e043 67 2>&1 >/dev/null
setkeycodes e023 68 2>&1 >/dev/null
setkeycodes e057 87 2>&1 >/dev/null
setkeycodes e058 88 2>&1 >/dev/null

# enable hotkeys
[ -x /etc/init.d/hotkey-setup ] && /etc/init.d/hotkey-setup start

update_progress 100

if checkbootparam "splash"; then
	sleep 1
	[ -p "$SPLASHY_PROGRESS_PIPE" -a -x /etc/init.d/splash.sh ] && /etc/init.d/splash.sh stop
	[ -p /etc/splashy/splashy.fifo ] && (echo exit > /etc/splashy/splashy.fifo) &
	sleep 1
fi

# delete named pipe
rm -f "$SPLASHY_PROGRESS_PIPE"
rm -f /etc/splashy/splashy.fifo

echo "6" > /proc/sys/kernel/printk

# Re-enable signals
trap 2 3 11

exit 0

